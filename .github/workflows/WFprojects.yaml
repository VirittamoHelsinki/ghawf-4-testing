#================================= project name & types =================================#
name: issues and pull request workflow automation
run-name: ${{ github.actor }} has ignited ${{ github.workflow }}
on:
  issues:
    types: [opened, reopened, closed, labeled, unlabeled, assigned, unassigned]
  pull_request:
    types: [opened, reopened, closed, labeled, unlabeled, review_requested, unassigned]

#========================================================================#

#================================= ENV =================================#

env:

  # ----------------- labels ----------------- #

  unassigned: Unassigned â•
  unlabeled: Unlabeled â—
  docs: Docs ðŸ“
  feat: Feat ðŸ†•
  style: Style ðŸ–Œï¸
  test: Test â˜‘ï¸
  refactor: Refactor ðŸ”
  bugfix: BugFix ðŸ›
  chore: Chore ðŸ‘·â€â™‚ï¸
  add: Add âž•
  backend: Backend âš™ï¸
  frontend: Frontend ðŸ–¥ï¸
  design: Design ðŸŽ¨

  # ----------------- projects fields ----------------- #

  un_assigned: Unassigned â•
  un_labeled: Unlabeled â—
  backlog: Backlog ðŸ“œ
  in_progress: In Progress ðŸš§
  ready_for_review: Ready for Review ðŸ”
  done: Done âœ”ï¸

  # ----------------- user/org related settings ----------------- #

  # username: 
  # gh_project_token: ${{ secrets.USE_THIS }}
  organization_name: VirittamoHelsinki
  gh_app_key: ${{ secrets.APP_SECRET_KEY }}
  gh_app_id: ${{ secrets.APP_ID }}
  gh_app_installation_id: ${{ secrets.APP_INSTALLATION_ID }}
  project_number: 17
  ## project_portfolio_number: # add here projects beta number that corresponds to project management portfolio for team leader or project manager to follow

  # ----------------- apps/handles for github actions (ignore for now) ----------------- #

  leduble: LeDuble/labeler@master # quick copy-pasta: ${{ env.andymckay }}
  leonsteinhaeuser: leonsteinhaeuser/project-beta-automations@v2.0.1 # quick copy-pasta: ${{ env.leonsteinhaeuser }}

#==================================================================#

#================================= Issues =================================#

#--------------------------------- ISSUE is OPENED || REOPENED ---------------------------------#

jobs:
  issue_opened: # issue opened or reopened
    name: issue_opened_or_reopened
    if: ${{ github.event_name == 'issues' && (github.event.action == 'opened' || github.event.action == 'reopened') }}
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to ${{ env.backlog }} # step 1 
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          # add-labels: 
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.backlog }}
          
      - name: If unlabeled, adds {{ env.unlabeled }} label # step 2
        uses: LeDuble/labeler@master
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          # gh_app_secret_key: ${{ env.gh_app_key }}
          # gh_app_ID: ${{ env.gh_app_id }}
          # gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          # organization: ${{ env.organization_name }}
          # project_id: ${{ env.project_number }}
          # resource_node_id: ${{ github.event.issue.node_id }}
          # status_value: ${{ env.un_labeled }}
          add-labels: ${{ env.unlabeled }}
          ignore-if-labeled: true

      - name: If unassigned, adds {{ env.unassigned }} label # step 3
        uses: LeDuble/labeler@master
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          # gh_app_secret_key: ${{ env.gh_app_key }}
          # gh_app_ID: ${{ env.gh_app_id }}
          # gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          # organization: ${{ env.organization_name }}
          # project_id: ${{ env.project_number }}
          # resource_node_id: ${{ github.event.issue.node_id }}
          # status_value: ${{ env.un_assigned }}
          add-labels: ${{ env.unassigned }}
          ignore-if-assigned: true

      - name: If an issue is reopened, adds ${{ env.backlog }} and removes ${{ env.done }} labels # step 4
        uses: LeDuble/labeler@master
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          # gh_app_secret_key: ${{ env.gh_app_key }}
          # gh_app_ID: ${{ env.gh_app_id }}
          # gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          # organization: ${{ env.organization_name }}
          # project_id: ${{ env.project_number }}
          # resource_node_id: ${{ github.event.issue.node_id }}
          # status_value: ${{ env.backlog }}
          add-labels: ${{ env.backlog }}
          remove-labels: ${{ env.done }}
#------------------------------------------------------------------#

#--------------------------------- ISSUE is CLOSED ---------------------------------#

  issue_closed: # issue closed
    name: issue_closed
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issues' && github.event.action == 'closed' }}
    steps:
      - name: Move issue to ${{ env.done }} # change name to print

        run: |
          echo "The id of this job is: $GITHUB_JOB"
          echo "The id of this action is: $GITHUB_ACTION"
          echo "Issue is assigned to ${{ env.done }} status value inside the projects board"

      - name: If closed, move issue to ${{ env.done }} # step 1
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.done }}
      - name: If closed, adds ${{ env.done }} label # step 2
        uses: LeDuble/labeler@master
        with:
          add-labels: ${{ env.done }}
          remove-labels: ${{ env.backlog }}, ${{ env.in_progress }}, ${{ env.ready_for_review }}

#------------------------------------------------------------------#

#--------------------------------- ISSUE is ASSIGNED || UNASSIGNED ---------------------------------#

  issue_assigned: # issue assigned or unassigned
    name: issue_assigned_unassigned
    if: ${{ github.event_name == 'issues' && (github.event.action == 'assigned' || github.event.action == 'unassigned') }}
    runs-on: ubuntu-latest
    steps:
      - name: if assigned, move issue to ${{ env.backlog }} # condition 1
        if: ${{ github.event.action == 'assigned' }}
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.backlog }}         
      - name: If assigned, adds ${{ env.backlog }} label # condition 1
        if: ${{ github.event.action == 'assigned' }}
        uses: LeDuble/labeler@master
        with:
          add-labels: ${{ env.backlog }}
          remove-labels: ${{ env.unassigned }}

      - name: if unassigned, move issue to ${{ env.unassigned }} # condition 2
        if: ${{ github.event.action == 'unassigned' }}
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.unassigned }}     
      - name: If unassigned, adds ${{ env.unassigned }} label # condition 2
        uses: LeDuble/labeler@master
        with:
          add-labels: ${{ env.unassigned }}
          remove-labels: ${{ env.backlog }}
          ignore-if-assigned: true

#--------------------------------- when ISSUE is LABELED ---------------------------------#

  # If an issue will be given label x -> then put it in the 
  issues_labeled:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issues' && github.event.action == 'labeled' }}
    steps:
      - name: In Progress # condition 1
        if: ${{ github.event.label.name == '${{ env.in_progress }}' }} # label with name: status/in-progress
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.in_progress }}
      
      - name: Review Requested # condition 2
        if: ${{ github.event.label.name == '${{ env.ready_for_review }}' }} # label with name: status/review-requested
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.ready_for_review }}

      - name: Done # condition 3
        if: ${{ github.event.label.name == '${{ env.done }}' }} # label with name: status/done
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.done }}

#--------------------------------- when ISSUE is UNLABELED ---------------------------------#

  issues_unlabeled:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'issues' && github.event.action == 'unlabeled' }}
    steps:
      - name: unlabeled # condition 1
        if: ${{ github.event.label.name == 'unlabeled' }}
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.un_labeled }}

#------------------------------------------------------------------#

#========================================================================#

#================================= Pull Request (PR) =================================#

#--------------------------------- PR is OPENED || REOPENED ---------------------------------#

  pr_opened_reopened:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened') }}
    steps:
      - name: move PR to ${{ env.in_progress }}  # step 1
        uses: leonsteinhaeuser/project-beta-automations@v2.0.1
        with:
          gh_app_secret_key: ${{ env.gh_app_key }}
          gh_app_ID: ${{ env.gh_app_id }}
          gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          organization: ${{ env.organization_name }}
          project_id: ${{ env.project_number }}
          resource_node_id: ${{ github.event.issue.node_id }}
          status_value: ${{ env.in_progress }}
      - name: adds label ${{ env.in_progress }} and remove labels ${{ env.done }} ${{ env.ready_for_review }} ${{ env.backlog }}   # step 2
        uses: LeDuble/labeler@master
        with:
          add-labels: ${{ env.in_progress }}
          remove-labels: ${{ env.done }}, ${{ env.ready_for_review }}, ${{ env.backlog }}
          ignore-if-assigned: true
      - name: If unassigned, adds {{ env.unassigned }} label # step 3
        uses: LeDuble/labeler@master
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          # gh_app_secret_key: ${{ env.gh_app_key }}
          # gh_app_ID: ${{ env.gh_app_id }}
          # gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          # organization: ${{ env.organization_name }}
          # project_id: ${{ env.project_number }}
          # resource_node_id: ${{ github.event.issue.node_id }}
          # status_value: ${{ env.un_assigned }}
          add-labels: ${{ env.unassigned }}
          ignore-if-assigned: true
      - name: If PR is reopened, adds ${{ env.in_progress }} and removes ${{ env.done }} labels # step 4
        uses: LeDuble/labeler@master
        with:
          # gh_token: ${{ env.gh_project_token }}
          # user: ${{ env.username }}
          # gh_app_secret_key: ${{ env.gh_app_key }}
          # gh_app_ID: ${{ env.gh_app_id }}
          # gh_app_installation_ID: ${{ env.gh_app_installation_id }}
          # organization: ${{ env.organization_name }}
          # project_id: ${{ env.project_number }}
          # resource_node_id: ${{ github.event.issue.node_id }}
          # status_value: ${{ env.backlog }}
          add-labels: ${{ env.in_progress }}
          remove-labels: ${{ env.done }}

#------------------------------------------------------------------#

#--------------------------------- PR is REVIEW REQUESTED ---------------------------------#


#------------------------------------------------------------------#

#--------------------------------- PR is CLOSED ---------------------------------#

#------------------------------------------------------------------#

#--------------------------------- PR is LABELED ---------------------------------#

#------------------------------------------------------------------#

#--------------------------------- PR is UNLABELED ---------------------------------#

#------------------------------------------------------------------#

#--------------------------------- PR is UNASSIGNED ---------------------------------#

#------------------------------------------------------------------#

#========================================================================#